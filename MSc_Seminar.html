<form id="voteForm">
  <label for="participantId">
    <strong>Your Email</strong> <span class="hint">(…@natur.cuni.cz or …@uochb.cas.cz)</span>
  </label>
  <input type="email" id="participantId" required>

  <div id="presentations"></div>

  <button type="submit" id="submitBtn">Submit voting</button>
</form>

<div id="message" aria-live="polite"></div>

<script>
const students = [
  { name: "Student 1", title: "Presentation title 1" },
  { name: "Student 2", title: "Presentation title 2" },
  { name: "Student 3", title: "Presentation title 3" },
  { name: "Student 4", title: "Presentation title 4" },
  { name: "Student 5", title: "Presentation title 5" }
];

const presDiv = document.getElementById("presentations");
const form = document.getElementById("voteForm");
const participantInput = document.getElementById("participantId");

function renderStudents(){
  presDiv.innerHTML = "";
  students.forEach((s,i)=>{
    const block = document.createElement('div');
    block.className = 'presentation-block';
    block.innerHTML = `
      <h3>${s.name}</h3>
      <p><strong>${s.title}</strong></p>
      <label>Proposed rank (1 = best, 5 = worst)</label>
      <select id="rank${i}" required>
        <option value="">--Select--</option>
        ${[1,2,3,4,5].map(n=>`<option value="${n}">${n}</option>`).join('')}
      </select>
    `;
    presDiv.appendChild(block);
  });
}

renderStudents();

function showMessage(text, type){
  const el = document.getElementById('message');
  el.textContent = text || '';
  el.className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
}

function safeIdForDoc(str){
  return String(str).trim().replace(/[.#$/\\[\\]]/g, '_');
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  showMessage('');

  const participant = participantInput.value.trim();
  if(!participant){
    showMessage("Please enter your email.", "error");
    return;
  }

  const ranks = [];
  for(let i=0;i<students.length;i++){
    const value = document.getElementById(`rank${i}`).value;
    if(!value){
      showMessage("Please assign a rank to each student.", "error");
      return;
    }
    ranks.push(parseInt(value));
  }

  const unique = new Set(ranks);
  if(unique.size !== students.length){
    showMessage("Each rank can be used only once.", "error");
    return;
  }

  const voteData = students.map((s,i)=>({
    name: s.name,
    title: s.title,
    rank: ranks[i]
  }));

  try{
    const safeId = safeIdForDoc(participant);
    const docRef = db.collection("msc_votes").doc(safeId);
    const existing = await docRef.get();
    if(existing.exists){
      showMessage("You have already voted.", "error");
      return;
    }

    await docRef.set({
      participant,
      votes: voteData,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    showMessage("Thank you for your vote!", "success");
    form.reset();

  }catch(err){
    console.error(err);
    showMessage("Error submitting vote.", "error");
  }
});
</script>
