<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PhD Seminar Feedback</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: #ffffff;
  display: flex;
  flex-direction: column;
}

main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 40px 0;
}

header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 40px;
}

header img {
  height: 130px;
  margin-bottom: 20px;
}

header h1 {
  margin: 0;
  color: #333;
  font-size: 26px;
}

input {
  padding: 8px;
  margin: 5px;
  border-radius: 5px;
  border: 1px solid #ccc;
  width: 90%;
  max-width: 300px;
}

button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  transition: background 0.2s ease;
}

button:hover {
  opacity: 0.9;
}

.error {
  color: red;
  font-weight: bold;
  margin-top: 10px;
}

.comment-box {
  width: 100%;
  max-width: 600px;
  padding: 12px;
  margin: 8px 0;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 1px 5px rgba(0,0,0,0.08);
  border-left: 4px solid #4CAF50;
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

footer {
  background-color: #ffffff;
  text-align: center;
  padding: 25px 15px;
  font-size: 14px;
  color: #000;
  border-top: 1px solid #ccc;
}
</style>
</head>
<body>

<main>
  <header>
    <img src="logo.jpg" alt="Department Logo">
    <h1>Feedback from the PhD Seminar</h1>
  </header>

  <div id="loginForm">
    <input type="email" id="email" placeholder="Enter your email"><br>
    <input type="password" id="password" placeholder="Enter your password"><br>
    <button id="loginBtn" style="background:#4CAF50;">Show Feedback</button>
    <div id="errorMsg" class="error"></div>
  </div>

  <div id="comments" style="display:none;"></div>

  <!-- LOGOUT BUTTON -->
  <button id="logoutBtn" style="display:none; margin-top:25px; background:#d9534f;">
    Log Out
  </button>

  <div id="changePasswordForm" style="margin-top:20px; display:none;">
    <h3>Change Password</h3>
    <input type="password" id="newPassword" placeholder="Enter new password"><br>
    <button id="changePasswordBtn" style="background:#4CAF50;">Update Password</button>
    <div id="passwordMsg" class="error"></div>
  </div>
</main>

<footer>
  <img src="logo.jpg" alt="PřF UK Logo" style="height: 55px; margin-bottom: 10px;">
  <p style="margin: 6px 0;">
    © 2025 Department of Organic Chemistry, Faculty of Science at Charles University in Prague
  </p>
  <p style="margin: 6px 0;">
    Hlavova 2030/8, Praha 2, 128 00 &nbsp;|&nbsp;
    Seminar Contacts: jiri.misek@natur.cuni.cz; kunakd@natur.cuni.cz
  </p>
  <p style="margin: 6px 0;">
    <a href="https://orgchem.natur.cuni.cz/" target="_blank" style="color: #000; text-decoration: none;">
      https://orgchem.natur.cuni.cz
    </a>
  </p>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3oSDoF5LC6pweqVinV2ykpJopQwFWulM",
  authDomain: "phd-seminar-voting.firebaseapp.com",
  projectId: "phd-seminar-voting",
  storageBucket: "phd-seminar-voting.firebasestorage.app",
  messagingSenderId: "1042633812969",
  appId: "1:1042633812969:web:7fa70745a53338ec5ab978",
  measurementId: "G-2JQDJWPH7L"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const emailToName = {
  "bolgarb@natur.cuni.cz": "Botond Bolgár",
  "vopalena@natur.cuni.cz": "Andrea Vopálenská",
  "najamulsahar@yahoo.com": "Najam Ul Sahar",
  "busetutuncu1@gmail.com": "Büşra Buse Tütüncü",
  "tuyuturtle@gmail.com": "Yu-Wei Tu",
  "trajhanf@natur.cuni.cz": "Filip Trajhan",
  "nidhi21155@gmail.com": "Nidhi Sinha",
  "sandyncc2792@gmail.com": "Sandip Baban Shinde",
  "rozankovasamanta@gmail.com": "Samanta Rožánková",
  "pipatpon.gong@gmail.com": "Pipatpon Raksapon",
  "martinedon@natur.cuni.cz": "Donna Martínez Lopéz",
  "ja.kubo@outlook.com": "Jakub Krištof",
  "ema.bazikova@uochb.cas.cz": "Ema Bažíková",
  "abc16685782@gmail.com": "Jialu Li",
  "b.kieftenbelt@outlook.com": "Bart Kieftenbelt",
  "jyotpreet.kaur@natur.cuni.cz": "Jyotpreet Kaur",
  "choudhapr@natur.cuni.cz": "Pratibha Choudhari",
  "hladik.ondrej@natur.cuni.cz": "Ondřej Hladík",
  "pallavihalkarni0704@gmail.com": "Pallavi Halkarni",
  "ondrej.danek4@gmail.com": "Ondřej Daněk",
  "cernalucie3@natur.cuni.cz": "Lucie Černá",
  "shubham.bhatt@natur.cuni.cz": "Shubham Bhatt",
  "marko.boskovic@uochb.cas.cz": "Marko Boskovic",
  "bukovaa@natur.cuni.cz": "Anna-Marie Dušková",
  "kunakd@natur.cuni.cz": "Dominik Kunák",
  "leonroda@natur.cuni.cz": "Alicia León Rodríguez"
};

// LOGIN
document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  const errorMsg = document.getElementById("errorMsg");
  const commentsDiv = document.getElementById("comments");

  commentsDiv.innerHTML = "";
  errorMsg.textContent = "";

  if (!email || !pass) {
    errorMsg.textContent = "Please enter email and password.";
    return;
  }

  try {
    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCredential.user;

    const presenterName = emailToName[user.email];
    if (!presenterName) {
      errorMsg.textContent = "Email not mapped to a presenter.";
      return;
    }

    document.getElementById("loginForm").style.display = "none";
    commentsDiv.style.display = "block";

    // Show logout button
    document.getElementById("logoutBtn").style.display = "inline-block";

    const userDocRef = db.collection('users').doc(user.email);
    const userDoc = await userDocRef.get();
    let passwordChanged = false;

    if (userDoc.exists) {
      passwordChanged = userDoc.data().passwordChanged || false;
    } else {
      await userDocRef.set({ name: presenterName, passwordChanged: false });
    }

    if (!passwordChanged) {
      document.getElementById("changePasswordForm").style.display = "block";
    }

    const snapshot = await db.collection('votes').get();
    let feedbacks = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.presentations && Array.isArray(data.presentations)) {
        data.presentations.forEach(p => {
          if (p.name === presenterName && p.comment && p.comment.trim() !== "") {
            feedbacks.push(p.comment);
          }
        });
      }
    });

    if (feedbacks.length === 0) {
      commentsDiv.innerHTML = "<p>No feedback submitted yet for this presenter.</p>";
    } else {
      feedbacks.forEach(c => {
        const box = document.createElement("div");
        box.className = "comment-box";
        box.textContent = c;
        commentsDiv.appendChild(box);
      });
    }

  } catch (error) {
    errorMsg.textContent = "Login failed: " + error.message;
  }
});

// CHANGE PASSWORD
document.getElementById("changePasswordBtn").addEventListener("click", async () => {
  const newPass = document.getElementById("newPassword").value;
  const passwordMsg = document.getElementById("passwordMsg");
  const user = firebase.auth().currentUser;

  passwordMsg.textContent = "";

  if (!user) {
    passwordMsg.textContent = "You must be logged in to change password.";
    return;
  }
  if (!newPass) {
    passwordMsg.textContent = "Please enter a new password.";
    return;
  }

  try {
    await user.updatePassword(newPass);
    await db.collection('users').doc(user.email).set({ passwordChanged: true }, { merge: true });

    passwordMsg.style.color = "green";
    passwordMsg.textContent = "Password updated successfully!";
    document.getElementById("changePasswordForm").style.display = "none";

  } catch (error) {
    passwordMsg.style.color = "red";
    passwordMsg.textContent = "Error: " + error.message;
  }
});

// LOGOUT
document.getElementById("logoutBtn").addEventListener("click", async () => {
  try {
    await firebase.auth().signOut();

    document.getElementById("email").value = "";
    document.getElementById("password").value = "";

    document.getElementById("comments").style.display = "none";
    document.getElementById("comments").innerHTML = "";
    document.getElementById("changePasswordForm").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";

    document.getElementById("loginForm").style.display = "block";

  } catch (error) {
    alert("Logout failed: " + error.message);
  }
});
</script>

</body>
</html>
