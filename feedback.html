<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PhD Seminar Feedback</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
header { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
header img { height: 120px; margin-bottom: 10px; }
header h1 { margin: 0; color: #333; font-size: 26px; }
input { padding: 8px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
button { padding: 8px 14px; border: none; border-radius: 6px; background: #4CAF50; color: white; cursor: pointer; }
button:hover { background: #45a049; }
.error { color: red; font-weight: bold; margin-top: 10px; }
.comment-box { width: 100%; max-width: 600px; padding: 12px; margin: 8px 0; border-radius: 8px; background: #fff; box-shadow: 0 1px 5px rgba(0,0,0,0.08); border-left: 4px solid #4CAF50; }
</style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Department Logo">
  <h1>Feedback from the PhD Seminar</h1>
</header>

<div id="loginForm">
  <input type="email" id="email" placeholder="Enter your email"><br>
  <input type="password" id="password" placeholder="Enter your password"><br>
  <button id="loginBtn">Show Feedback</button>
  <div id="errorMsg" class="error"></div>
</div>

<div id="comments"></div>

<div id="changePasswordForm" style="margin-top:20px; display:none;">
  <h3>Change Password</h3>
  <input type="password" id="newPassword" placeholder="Enter new password"><br>
  <button id="changePasswordBtn">Update Password</button>
  <div id="passwordMsg" class="error"></div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA3oSDoF5LC6pweqVinV2ykpJopQwFWulM",
  authDomain: "phd-seminar-voting.firebaseapp.com",
  projectId: "phd-seminar-voting",
  storageBucket: "phd-seminar-voting.firebasestorage.app",
  messagingSenderId: "1042633812969",
  appId: "1:1042633812969:web:7fa70745a53338ec5ab978",
  measurementId: "G-2JQDJWPH7L"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Přiřazení email → jméno prezentujícího
const emailToName = {
  "bolgarb@natur.cuni.cz": "Botond Bolgár",
  "vopalena@natur.cuni.cz": "Andrea Vopálenská",
  "najamulsahar@yahoo.com": "Najam Ul Sahar",
  "busetutuncu1@gmail.com": "Büşra Buse Tütüncü",
  "tuyuturtle@gmail.com": "Yu-Wei Tu",
  "trajhanf@natur.cuni.cz": "Filip Trajhan",
  "nidhi21155@gmail.com": "Nidhi Sinha",
  "sandyncc2792@gmail.com": "Sandip Baban Shinde",
  "rozankovasamanta@gmail.com": "Samanta Rožánková",
  "pipatpon.gong@gmail.com": "Pipatpon Raksapon",
  "martinedon@natur.cuni.cz": "Donna Martínez Lopéz",
  "abc16685782@gmail.com": "Jakub Krištof",
  "eonroda@natur.cuni.cz": "Ema Bažíková",
  "ja.kubo@outlook.com": "Jialu Li",
  "b.kieftenbelt@outlook.com": "Bart Kieftenbelt",
  "jyotpreet.kaur@natur.cuni.cz": "Jyotpreet Kaur",
  "choudhapr@natur.cuni.cz": "Pratibha Choudhari",
  "hladik.ondrej@natur.cuni.cz": "Ondřej Hladík",
  "pallavihalkarni0704@gmail.com": "Pallavi Halkarni",
  "ondrej.danek4@gmail.com": "Ondřej Daněk",
  "cernalucie3@natur.cuni.cz": "Lucie Černá"
};

// Přihlášení přes Firebase Auth
document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  const errorMsg = document.getElementById("errorMsg");
  const commentsDiv = document.getElementById("comments");
  commentsDiv.innerHTML = "";
  errorMsg.textContent = "";

  if (!email || !pass) {
    errorMsg.textContent = "Please enter email and password.";
    return;
  }

  try {
    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCredential.user;
    document.getElementById("changePasswordForm").style.display = "block";

    const presenterName = emailToName[user.email];
    if (!presenterName) {
      errorMsg.textContent = "Email not mapped to a presenter.";
      return;
    }

    const snapshot = await db.collection('votes').get();
    let feedbacks = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.presentations && Array.isArray(data.presentations)) {
        data.presentations.forEach(p => {
          if (p.name === presenterName && p.comment && p.comment.trim() !== "") {
            feedbacks.push(p.comment);
          }
        });
      }
    });

    if (feedbacks.length === 0) {
      commentsDiv.innerHTML = "<p>No feedback submitted yet for this presenter.</p>";
    } else {
      feedbacks.forEach(c => {
        const box = document.createElement("div");
        box.className = "comment-box";
        box.textContent = c;
        commentsDiv.appendChild(box);
      });
    }

  } catch (error) {
    errorMsg.textContent = "Login failed: " + error.message;
  }
});

// Změna hesla
document.getElementById("changePasswordBtn").addEventListener("click", async () => {
  const newPass = document.getElementById("newPassword").value;
  const passwordMsg = document.getElementById("passwordMsg");
  passwordMsg.textContent = "";
  const user = firebase.auth().currentUser;

  if (!user) {
    passwordMsg.textContent = "You must be logged in to change password.";
    return;
  }
  if (!newPass) {
    passwordMsg.textContent = "Please enter a new password.";
    return;
  }

  try {
    await user.updatePassword(newPass);
    passwordMsg.style.color = "green";
    passwordMsg.textContent = "Password updated successfully!";
  } catch (error) {
    passwordMsg.style.color = "red";
    passwordMsg.textContent = "Error: " + error.message;
  }
});
</script>
</body>
</html>
