<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PhD Seminar Evaluation</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  min-height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial;
  display: flex;
  flex-direction: column;
}
body {
  max-width: 800px;
  margin: 0 auto;
  padding: 30px 20px;
  flex: 1;
}
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
}
header img { height: 120px; margin-bottom: 10px; }
header h1 { margin: 0; color: #333; font-size: 28px; text-align: center; }

label { display:block; margin-top:15px; font-weight:bold; }
input, select, textarea, button { width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
textarea { resize: vertical; transition: background-color 0.2s, color 0.2s; }
button { font-size:16px; margin-top:10px; cursor: pointer; }
.success { color: green; margin-top:20px; }
.error { color: red; margin-top:20px; }

.presentation-block { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-top: 20px; background: #fafafa; box-shadow: 1px 1px 5px rgba(0,0,0,0.05); }
.presentation-block h3 { margin-top: 0; color: #444; }

.checkbox-row {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 6px;
  margin-top: 5px;
}
.checkbox-row input[type="checkbox"] {
  width: auto;
  cursor:pointer;
}
.checkbox-row label {
  margin: 0;
  cursor: pointer;
}

textarea:disabled { background-color: #eee; color: #666; }

footer {
  background-color: #ffffff;
  text-align: center;
  padding: 25px 15px;
  font-size: 14px;
  color: #000;
  border-top: 1px solid #ccc;
  margin-top: auto;
}

/* Mobile optimization */
@media (max-width: 600px) {
  body { padding: 15px; }
  header img { height: 90px; }
  header h1 { font-size: 22px; }
}
</style>

</head>
<body>

<header>
  <img src="logo.jpg" alt="Department Logo">
  <h1>PhD Seminar Evaluation</h1>
</header>
  
<div style="
  border: 2px solid #444;
  padding: 12px 15px;
  border-radius: 6px;
  background: #fff;
  margin-bottom: 25px;
">

  <h3 style="
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #000;
    text-align: center;
    font-weight: bold;
  ">
    Instructions (for Email/Participant ID)
  </h3>

  <p style="
    margin: 0;
    font-size: 14px;
    color: #000;
    line-height: 1.45;
    text-align: left;
  ">
    <strong>Students:</strong> Please enter your faculty email (...@natur.cuni.cz) or IOCB email (...@uochb.cas.cz).<br>
    <strong>Academic staff:</strong> Please enter your full name (name and surname).
  </p>

</div>


<form id="voteForm">
  <label for="participantId">Email (Participant ID)</label>
  <input type="text" id="participantId" required>

  <label for="seminar">Select seminar</label>
  <select id="seminar" required>
    <option value="">--Select--</option>
  </select>

  <div id="presentations"></div>

  <button type="submit">Submit evaluation</button>
</form>

<div id="message"></div>

<script>
// -------------------------------------------------------------
// FIREBASE INIT
// -------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyA3oSDoF5LC6pweqVinV2ykpJopQwFWulM",
  authDomain: "phd-seminar-voting.firebaseapp.com",
  projectId: "phd-seminar-voting",
  storageBucket: "phd-seminar-voting.firebasestorage.app",
  messagingSenderId: "1042633812969",
  appId: "1:1042633812969:web:7fa70745a53338ec5ab978"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// -------------------------------------------------------------
// SEMINARS & PRESENTATIONS
// -------------------------------------------------------------
const seminars = [
  { name: "Seminar 1", date: "2025-11-14" },
  { name: "Seminar 2", date: "2025-12-12" },
  { name: "Seminar 3", date: "2026-01-16" },
  { name: "Seminar 4", date: "2026-02-13" },
  { name: "Seminar 5", date: "2026-04-10" },
  { name: "Seminar 6", date: "2026-05-15" }
];

const presentationsBySeminar = {
  "Seminar 1": ["Marko Boskovic", "Büşra Buse Tütüncü", "Samanta Rožánková", "Yu-Wei Tu"],
  "Seminar 2": ["Bart Kieftenbelt", "Ema Bažíková", "Pratibha Choudhari", "Botond Bolgár"],
  "Seminar 3": ["Anna-Marie Dušková", "Pallavi Halkarni", "Pipatpon Raksapon", "Ondřej Daněk"],
  "Seminar 4": ["Filip Trajhan", "Alicia León Rodríguez", "Jakub Krištof", "Andrea Vopálenská"],
  "Seminar 5": ["Ondřej Hladík", "Lucie Černá", "Shubham Bhatt", "Nidhi Sinha"],
  "Seminar 6": ["Najam Ul Sahar", "Jyotpreet Kaur", "Sandip Baban Shinde", "Dominik Kunák"]
};

// -------------------------------------------------------------
// DOM ELEMENTS
// -------------------------------------------------------------
const seminarSelect = document.getElementById("seminar");
const presDiv = document.getElementById("presentations");
const form = document.getElementById("voteForm");
const message = document.getElementById("message");

// -------------------------------------------------------------
// SEMINAR DROPDOWN (NO CLOSING DATE ANYMORE!)
// -------------------------------------------------------------
function updateSeminarDropdown() {
  const now = new Date();
  seminarSelect.innerHTML = '<option value="">--Select--</option>';

  seminars.forEach(s => {
    const date = new Date(s.date);
    const openDate = new Date(date);
    openDate.setDate(openDate.getDate() - 1);

    let text = `${s.name} on ${date.toLocaleDateString("en-GB")}`;
    let disabled = false;
    let tooltip = "";

    if (now < openDate) {
      text += " (not yet open)";
      tooltip = `Voting opens ${openDate.toLocaleDateString("en-GB")}`;
      disabled = true;
    }

    const opt = document.createElement("option");
    opt.value = s.name;
    opt.textContent = text;
    opt.disabled = disabled;
    opt.title = tooltip;

    seminarSelect.appendChild(opt);
  });
}
updateSeminarDropdown();

// -------------------------------------------------------------
// RENDER PRESENTATION BLOCKS
// -------------------------------------------------------------
function renderPresentations(seminar) {
  presDiv.innerHTML = "";
  if (!seminar) return;

  const list = presentationsBySeminar[seminar] || [];

  list.forEach((name, i) => {
    const block = document.createElement("div");
    block.className = "presentation-block";
    block.innerHTML = `
      <h3>${name}</h3>

      <label>Score (1 = worst, 10 = best)</label>
      <select id="pres${i+1}" required>
        <option value="">--Select--</option>
        ${Array.from({length: 10}, (_,x)=>`<option value="${x+1}">${x+1}</option>`).join("")}
      </select>

      <label>What should be improved?</label>
      <textarea id="comment${i+1}" rows="3"></textarea>

      <div class="checkbox-row">
        <input type="checkbox" id="nocmt${i+1}">
        <label for="nocmt${i+1}">No comments</label>
      </div>
    `;

    presDiv.appendChild(block);

    const checkbox = block.querySelector(`#nocmt${i+1}`);
    const textarea = block.querySelector(`#comment${i+1}`);

    checkbox.addEventListener("change", () => {
      textarea.disabled = checkbox.checked;
      if (checkbox.checked) textarea.value = "";
      saveDraft();
    });
  });

  loadDraft();
}

seminarSelect.addEventListener("change", () => {
  renderPresentations(seminarSelect.value);
  saveDraft();
});

// -------------------------------------------------------------
// AUTOSAVE (localStorage)
// -------------------------------------------------------------
function saveDraft() {
  const data = {
    participantId: document.getElementById("participantId").value,
    seminar: seminarSelect.value,
    presentations: []
  };

  const seminar = seminarSelect.value;
  if (seminar && presentationsBySeminar[seminar]) {
    presentationsBySeminar[seminar].forEach((name, i) => {
      data.presentations.push({
        score: document.getElementById(`pres${i+1}`)?.value || "",
        comment: document.getElementById(`comment${i+1}`)?.value || "",
        noComment: document.getElementById(`nocmt${i+1}`)?.checked || false
      });
    });
  }

  localStorage.setItem("phd_eval_draft", JSON.stringify(data));
}

function loadDraft() {
  const data = JSON.parse(localStorage.getItem("phd_eval_draft") || "{}");

  if (data.participantId) document.getElementById("participantId").value = data.participantId;
  if (data.seminar && seminarSelect.value === "") seminarSelect.value = data.seminar;

  if (data.presentations) {
    data.presentations.forEach((p, i) => {
      const scoreEl = document.getElementById(`pres${i+1}`);
      const cmtEl = document.getElementById(`comment${i+1}`);
      const chkEl = document.getElementById(`nocmt${i+1}`);

      if (scoreEl) scoreEl.value = p.score || "";
      if (chkEl) chkEl.checked = p.noComment || false;
      if (cmtEl) {
        cmtEl.value = p.comment || "";
        cmtEl.disabled = p.noComment;
      }
    });
  }
}

// Save on any input change
document.addEventListener("input", saveDraft);

// -------------------------------------------------------------
// WARNING ON LEAVING PAGE
// -------------------------------------------------------------
let formSubmitted = false;
window.addEventListener("beforeunload", e => {
  if (!formSubmitted) {
    e.preventDefault();
    e.returnValue = "";
  }
});

// -------------------------------------------------------------
// SUBMISSION
// -------------------------------------------------------------
form.addEventListener("submit", async e => {
  e.preventDefault();
  message.textContent = "";
  formSubmitted = true;

  const participantId = document.getElementById("participantId").value.trim();
  const seminar = seminarSelect.value;

  if (!participantId || !seminar) {
    message.textContent = "Please fill in all required fields.";
    message.className = "error";
    return;
  }

  // Gather presentation scores
  const list = presentationsBySeminar[seminar];
  const evaluations = [];

  for (let i = 0; i < list.length; i++) {
    const score = document.getElementById(`pres${i+1}`).value;
    const comment = document.getElementById(`comment${i+1}`).value.trim();
    const noComment = document.getElementById(`nocmt${i+1}`).checked;

    if (!score) {
      message.textContent = "Please fill in a score for each presentation.";
      message.className = "error";
      return;
    }

    evaluations.push({
      name: list[i],
      score: parseInt(score),
      comment: noComment ? "" : comment
    });
  }

  // Check if already voted
  const docRef = db.collection("votes").doc(`${participantId}_${seminar}`);
  const existing = await docRef.get();
  if (existing.exists) {
    message.textContent = "You have already submitted an evaluation for this seminar.";
    message.className = "error";
    return;
  }

  // Submit
  try {
    await docRef.set({
      participantId,
      seminar,
      presentations: evaluations,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    message.textContent = "Evaluation submitted successfully. Thank you!";
    message.className = "success";

    localStorage.removeItem("phd_eval_draft");
    form.reset();
    presDiv.innerHTML = "";

  } catch (err) {
    console.error(err);
    message.textContent = "An error occurred while submitting.";
    message.className = "error";
  }
});
</script>

<footer>
  <img src="logo.jpg" alt="Faculty Logo" style="height: 55px; margin-bottom: 10px;">
  <p style="margin: 6px 0;">© 2025 Department of Organic Chemistry, Faculty of Science, Charles University</p>
  <p style="margin: 6px 0;">Hlavova 2030/8, Prague 2, 128 00 | Seminar Contacts: jiri.misek@natur.cuni.cz; dominik.kunak@natur.cuni.cz</p>
  <p style="margin: 6px 0;">
    <a href="https://orgchem.natur.cuni.cz/" target="_blank" style="color: #000; text-decoration: none;">https://orgchem.natur.cuni.cz</a>
  </p>
</footer>

</body>
</html>
