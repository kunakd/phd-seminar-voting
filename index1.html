<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PhD Seminar Evaluation</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
html, body {
  min-height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial;
  display: flex;
  flex-direction: column;
}
body {
  max-width: 800px;
  margin: 0 auto;
  padding: 30px 20px;
  flex: 1;
  background: #f5f6f8;
}
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
  background: #003366;
  color: #fff;
  padding: 20px 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
header img { height: 90px; margin-bottom: 10px; }
header h1 { margin: 0; color: #fff; font-size: 26px; text-align: center; }
header .subtitle { margin-top:8px; font-size:14px; color: rgba(255,255,255,0.9); }

label { display:block; margin-top:15px; font-weight:bold; }
input, select, textarea, button { width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; background: #fff; }
textarea { resize: vertical; transition: background-color 0.2s, color 0.2s; }
button { font-size:16px; margin-top:10px; cursor: pointer; background: #003366; color: #fff; border: none; padding: 10px 14px; border-radius: 6px; }
.success { color: green; margin-top:20px; }
.error { color: red; margin-top:20px; }

.presentation-block { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-top: 20px; background: #fafafa; box-shadow: 1px 1px 5px rgba(0,0,0,0.05); }
.presentation-block h3 { margin-top: 0; color: #444; }

.checkbox-row {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 6px;
  margin-top: 5px;
}
.checkbox-row input[type="checkbox"] {
  width: auto;
  cursor:pointer;
}
.checkbox-row label {
  margin: 0;
  cursor: pointer;
}

textarea:disabled { background-color: #eee; color: #666; }

footer {
  background-color: #ffffff;
  text-align: center;
  padding: 25px 15px;
  font-size: 14px;
  color: #000;
  border-top: 1px solid #ccc;
  margin-top: 30px;
  border-radius: 6px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.03);
}

.info-line { font-size:13px; color:#333; margin-bottom:10px; }

@media (max-width:700px) {
  body { padding: 18px 12px; }
  header img { height: 72px; }
  header h1 { font-size: 20px; }
  footer { padding: 18px 10px; font-size: 13px; }
  .presentation-block { padding: 12px; }
}
</style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Department Logo">
  <h1>PhD Seminar Evaluation</h1>
  <div class="subtitle">Please submit one evaluation per seminar. UI language: English</div>
</header>

<form id="voteForm" aria-live="polite">
  <label for="participantId">Participant ID</label>
  <input type="text" id="participantId" required placeholder="e.g. s12345 or your email">

  <label for="seminar">Select seminar</label>
  <select id="seminar" required>
    <option value="">--Select--</option>
  </select>

  <div class="info-line">This form records scores (1 = worst, 10 = best) and optional comments. Progress is saved automatically in your browser. Voting opens the day before the seminar; there is no closing date.</div>

  <div id="presentations" aria-live="polite"></div>

  <div style="display:flex;gap:10px;margin-top:12px;">
    <button type="submit" id="submitBtn">Submit evaluation</button>
    <button type="button" id="clearDraft" style="background:#777">Clear saved draft</button>
  </div>

  <div id="message" role="status" style="margin-top:12px;"></div>
</form>

<footer>
  <img src="logo.jpg" alt="Faculty Logo" style="height: 55px; margin-bottom: 10px;">
  <p style="margin: 6px 0;">© 2025 Department of Organic Chemistry, Faculty of Science, Charles University</p>
  <p style="margin: 6px 0;">Hlavova 2030/8, Prague 2, 128 00 | Seminar Contacts: jiri.misek@natur.cuni.cz; dominik.kunak@natur.cuni.cz</p>
  <p style="margin: 6px 0;">
    <a href="https://orgchem.natur.cuni.cz/" target="_blank" style="color: #000; text-decoration: none;">https://orgchem.natur.cuni.cz</a>
  </p>
</footer>

<script>
// -------------------- Firestore init --------------------
const firebaseConfig = {
  apiKey: "AIzaSyA3oSDoF5LC6pweqVinV2ykpJopQwFWulM",
  authDomain: "phd-seminar-voting.firebaseapp.com",
  projectId: "phd-seminar-voting",
  storageBucket: "phd-seminar-voting.firebasestorage.app",
  messagingSenderId: "1042633812969",
  appId: "1:1042633812969:web:7fa70745a53338ec5ab978"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// try enabling persistence (optional)
firebase.firestore().enablePersistence().catch(function(err) {
  console.warn('Persistence not enabled:', err && err.code ? err.code : err);
});

// -------------------- Data --------------------
const seminars = [
  { name: "Seminar 1", date: "2025-11-14" },
  { name: "Seminar 2", date: "2025-12-12" },
  { name: "Seminar 3", date: "2026-01-16" },
  { name: "Seminar 4", date: "2026-02-13" },
  { name: "Seminar 5", date: "2026-04-10" },
  { name: "Seminar 6", date: "2026-05-15" }
];

const presentationsBySeminar = {
  "Seminar 1": ["Marko Boskovic", "Büşra Buse Tütüncü", "Samanta Rožánková", "Yu-Wei Tu"],
  "Seminar 2": ["Bart Kieftenbelt", "Ema Bažíková", "Pratibha Choudhari", "Botond Bolgár"],
  "Seminar 3": ["Anna-Marie Dušková", "Pallavi Halkarni", "Pipatpon Raksapon", "Ondřej Daněk"],
  "Seminar 4": ["Filip Trajhan", "Alicia León Rodríguez", "Jakub Krištof", "Andrea Vopálenská"],
  "Seminar 5": ["Ondřej Hladík", "Lucie Černá", "Shubham Bhatt", "Nidhi Sinha"],
  "Seminar 6": ["Najam Ul Sahar", "Jyotpreet Kaur", "Sandip Baban Shinde", "Dominik Kunák"]
};

// -------------------- DOM refs --------------------
const seminarSelect = document.getElementById('seminar');
const presDiv = document.getElementById('presentations');
const form = document.getElementById('voteForm');
const participantInput = document.getElementById('participantId');
const messageEl = document.getElementById('message');
const submitBtn = document.getElementById('submitBtn');
const clearDraftBtn = document.getElementById('clearDraft');

let formDirty = false;
let formSubmitted = false;

// -------------------- Helpers --------------------
function setMessage(text, type='') {
  messageEl.textContent = text;
  messageEl.className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
}

function localKeyForField(seminarName, fieldId) {
  return `draft__${seminarName}__${fieldId}`;
}

function clearDraftForSeminar(seminarName) {
  if (!seminarName) return;
  const names = presentationsBySeminar[seminarName] || [];
  names.forEach((_, idx) => {
    const i = idx + 1;
    localStorage.removeItem(localKeyForField(seminarName, `score${i}`));
    localStorage.removeItem(localKeyForField(seminarName, `comment${i}`));
    localStorage.removeItem(localKeyForField(seminarName, `nocmt${i}`));
  });
  // keep participantId optional, but remove if you want:
  localStorage.removeItem('participantId');
}

// -------------------- Dropdown (open date only) --------------------
function updateSeminarDropdown() {
  const currentSelection = seminarSelect.value; // keep selection
  seminarSelect.innerHTML = '<option value="">--Select--</option>';
  const now = new Date();
  seminars.forEach(s => {
    const date = new Date(s.date);
    const openDate = new Date(date);
    openDate.setDate(openDate.getDate() - 1); // open day before
    const option = document.createElement('option');
    option.value = s.name;
    option.textContent = `${s.name} on ${date.toLocaleDateString('en-GB')}`;
    if (now < openDate) {
      option.disabled = true;
      option.textContent += ' (not yet open)';
      option.title = `Voting opens ${openDate.toLocaleDateString('en-GB')}`;
    } else {
      option.title = 'Voting is open';
    }
    seminarSelect.appendChild(option);
  });
  // restore selection if possible and still present
  if (currentSelection) {
    const opt = Array.from(seminarSelect.options).find(o => o.value === currentSelection);
    if (opt) seminarSelect.value = currentSelection;
    // do not auto-render here; render only when value really changed by user or init
  }
}
updateSeminarDropdown();
// update periodically to reflect new opens (won't reset selection)
setInterval(updateSeminarDropdown, 60000);

// -------------------- Render presentations (preserve draft) --------------------
function renderPresentations(seminarName) {
  presDiv.innerHTML = '';
  if (!seminarName) return;
  const names = presentationsBySeminar[seminarName] || [];

  names.forEach((name, idx) => {
    const i = idx + 1;
    const block = document.createElement('div');
    block.className = 'presentation-block';
    block.innerHTML = `
      <h3>${name}</h3>
      <label for="score${i}">Score (1 - 10)</label>
      <select id="score${i}" required>
        <option value="">--Select--</option>
        ${Array.from({length:10}, (_,j) => `<option value="${j+1}">${j+1}</option>`).join('')}
      </select>

      <label for="comment${i}">What should be improved?</label>
      <textarea id="comment${i}" rows="3"></textarea>

      <div class="checkbox-row">
        <input type="checkbox" id="nocmt${i}">
        <label for="nocmt${i}">No comments</label>
      </div>
    `;
    presDiv.appendChild(block);

    const scoreEl = block.querySelector(`#score${i}`);
    const commentEl = block.querySelector(`#comment${i}`);
    const nocmtEl = block.querySelector(`#nocmt${i}`);

    // Restore saved draft values (if any)
    const savedScore = localStorage.getItem(localKeyForField(seminarName, `score${i}`));
    if (savedScore !== null) scoreEl.value = savedScore;
    const savedComment = localStorage.getItem(localKeyForField(seminarName, `comment${i}`));
    if (savedComment !== null) commentEl.value = savedComment;
    const savedNoCmt = localStorage.getItem(localKeyForField(seminarName, `nocmt${i}`));
    if (savedNoCmt === '1') {
      nocmtEl.checked = true;
      commentEl.disabled = true;
    }

    // Autosave events
    scoreEl.addEventListener('change', () => {
      formDirty = true;
      localStorage.setItem(localKeyForField(seminarName, scoreEl.id), scoreEl.value);
    });
    commentEl.addEventListener('input', () => {
      formDirty = true;
      localStorage.setItem(localKeyForField(seminarName, commentEl.id), commentEl.value);
    });
    nocmtEl.addEventListener('change', () => {
      formDirty = true;
      commentEl.disabled = nocmtEl.checked;
      if (nocmtEl.checked) {
        commentEl.value = '';
        localStorage.removeItem(localKeyForField(seminarName, `comment${i}`));
        localStorage.setItem(localKeyForField(seminarName, `nocmt${i}`), '1');
      } else {
        localStorage.removeItem(localKeyForField(seminarName, `nocmt${i}`));
      }
    });
  });

  // restore participant id if saved and not typed
  const savedPid = localStorage.getItem('participantId');
  if (savedPid && !participantInput.value) participantInput.value = savedPid;
}

// Only render when user changes selection (prevents accidental resets)
seminarSelect.addEventListener('change', (e) => {
  renderPresentations(e.target.value);
});

// participant ID autosave
participantInput.addEventListener('input', () => {
  formDirty = true;
  localStorage.setItem('participantId', participantInput.value.trim());
});

// clear draft
clearDraftBtn.addEventListener('click', () => {
  const seminar = seminarSelect.value;
  if (!seminar) {
    setMessage('Choose a seminar first to clear the draft for it.', 'error');
    return;
  }
  clearDraftForSeminar(seminar);
  renderPresentations(seminar);
  setMessage('Draft cleared for selected seminar.');
});

// warn on unsaved changes
window.addEventListener('beforeunload', (e) => {
  if (formDirty && !formSubmitted) {
    e.preventDefault();
    e.returnValue = 'You have unsaved changes — your vote is not submitted yet.';
    return e.returnValue;
  }
});

// -------------------- Submission (1 per participant per seminar) --------------------
form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  setMessage('');

  const participantId = participantInput.value.trim();
  const seminar = seminarSelect.value;
  if (!participantId) { setMessage('Please enter your Participant ID.', 'error'); return; }
  if (!seminar) { setMessage('Please select a seminar.', 'error'); return; }

  const presNames = presentationsBySeminar[seminar] || [];
  const presentations = [];
  for (let i = 0; i < presNames.length; i++) {
    const idx = i + 1;
    const scoreEl = document.getElementById(`score${idx}`);
    const commentEl = document.getElementById(`comment${idx}`);
    const nocmtEl = document.getElementById(`nocmt${idx}`);
    if (!scoreEl || !scoreEl.value) { setMessage('Please provide a score for each presentation (1–10).', 'error'); return; }
    const score = parseInt(scoreEl.value, 10);
    if (Number.isNaN(score) || score < 1 || score > 10) { setMessage('Scores must be numbers between 1 and 10.', 'error'); return; }
    const comment = (nocmtEl && nocmtEl.checked) ? '' : (commentEl ? commentEl.value.trim() : '');
    presentations.push({ name: presNames[i], score, comment });
  }

  const voteData = {
    participantId,
    seminar,
    presentations,
    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // deterministic doc id prevents duplicates: one doc per participant per seminar
  const docId = `${seminar}__${participantId}`.replace(/\s+/g, '_');
  const docRef = db.collection('votes').doc(docId);

  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  try {
    await db.runTransaction(async (tx) => {
      const docSnapshot = await tx.get(docRef);
      if (docSnapshot.exists) throw new Error('ALREADY_SUBMITTED');
      tx.set(docRef, voteData);
    });

    formSubmitted = true;
    formDirty = false;
    clearDraftForSeminar(seminar);
    setMessage('Evaluation submitted successfully. Thank you!', 'success');

    // visually lock the form after submit
    submitBtn.textContent = 'Submitted';
    submitBtn.disabled = true;
    Array.from(document.querySelectorAll('#presentations input, #presentations textarea, #presentations select')).forEach(el => el.disabled = true);
    participantInput.disabled = true;
    seminarSelect.disabled = true;

  } catch (err) {
    if (err && err.message === 'ALREADY_SUBMITTED') {
      setMessage('You have already submitted an evaluation for this seminar (one submission per Participant ID).', 'error');
    } else {
      console.error('Submit error', err);
      setMessage('An error occurred while submitting. Your draft is saved locally and will remain until you retry.', 'error');
    }
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit evaluation';
  }
});

// -------------------- Init: restore saved draft or select first open seminar --------------------
(function initFromDraft() {
  const savedPid = localStorage.getItem('participantId');
  if (savedPid) participantInput.value = savedPid;

  // try restore a seminar that has a draft
  let restored = false;
  for (const s of seminars) {
    const names = presentationsBySeminar[s.name] || [];
    if (names.length === 0) continue;
    const key = localKeyForField(s.name, 'score1');
    if (localStorage.getItem(key) !== null) {
      seminarSelect.value = s.name;
      renderPresentations(s.name);
      restored = true;
      break;
    }
  }
  if (!restored) {
    // if nothing to restore, preselect the first open seminar (optional)
    const now = new Date();
    for (const s of seminars) {
      const date = new Date(s.date);
      const openDate = new Date(date); openDate.setDate(openDate.getDate()-1);
      if (now >= openDate) { seminarSelect.value = s.name; /* don't auto-render to avoid overwriting if user starts typing; render only if they explicitly open */ break; }
    }
  }
})();
</script>
</body>
</html>
