<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PhD Seminar Evaluation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  min-height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
}

body {
  max-width: 800px;
  margin: 0 auto;
  padding: 30px 20px;
  flex: 1;
  background-color: #fff;
}

/* Header */
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
}
header img { height: 120px; margin-bottom: 10px; max-width: 100%; object-fit: contain; }
header h1 { margin: 0; color: #333; font-size: 28px; text-align: center; }

/* Navbar */
.navbar {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  margin-top: 15px;
}
.nav-btn {
  padding: 12px 16px;
  background: #4a4a4a;
  color: white;
  border-radius: 8px;
  text-decoration: none;
  font-size: 16px;
  transition: background 0.2s;
}
.nav-btn:hover { background: #000; }

/* Instructions */
.instructions {
  border: 2px solid #444;
  padding: 15px 20px;
  border-radius: 10px;
  background: #fff;
  margin-bottom: 25px;
  line-height: 1.6;
}
.instructions strong {
  font-size: 20px; /* stejná velikost jako label */
}
.instructions p {
  font-size: 18px; /* stejná velikost jako text input/select */
  margin: 5px 0;
}

/* Form Elements */
label { display:block; margin-top:15px; font-weight:bold; font-size:20px; }
input, select, textarea, button {
  width: 100%;
  padding: 14px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size: 18px;
}
textarea { resize: vertical; transition: background-color 0.2s, color 0.2s; }
textarea:disabled { background-color: #eee; color: #666; }

/* Submit button */
#submitBtn {
  background-color: #39FF14;
  color: #000;
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-size: 18px;
  cursor: pointer;
  transition: background-color 0.2s;
  text-align: center;
}
#submitBtn:hover { background-color: #32CC12; }

/* Presentation blocks */
.presentation-block { 
  border: 1px solid #ccc; 
  border-radius: 8px; 
  padding: 15px; 
  margin-top: 25px; 
  margin-bottom: 25px; 
  background: #fafafa; 
  box-shadow: 1px 1px 5px rgba(0,0,0,0.05); 
  font-size:18px; 
}
.presentation-block h3 { 
  margin-top: 0; 
  color: #444; 
  font-weight: bold; 
  font-size: 20px; /* stejná velikost jako label */
}

/* Checkbox styling */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}
.checkbox-row input[type="checkbox"] {
  width: auto;
  cursor:pointer;
  transform: scale(1.3);
}
.checkbox-row label { margin: 0; cursor: pointer; }

/* Messages */
.success { color: green; margin-top:20px; font-size:18px; }
.error { color: red; margin-top:20px; font-size:18px; }

/* Footer */
footer {
  background-color: #ffffff;
  text-align: center;
  padding: 25px 10px;
  font-size: 16px; 
  color: #000;
  border-top: 1px solid #ccc;
  margin-top: auto;
}
footer img { height: 70px; margin-bottom: 10px; max-width: 100%; }

/* Mobile-specific adjustments */
@media (max-width: 600px) {
  body { padding: 15px; font-size: 18px; min-height: 100vh; display: flex; flex-direction: column; justify-content: flex-start; }
  header img { height: 140px; }
  header h1 { font-size: 28px; }
  .nav-btn { font-size: 18px; padding: 16px 18px; }
  input, select, textarea, button { font-size: 20px; padding: 18px; }
  select, input, textarea { margin-bottom: 16px; }
  .presentation-block { padding: 22px; font-size: 20px; border-radius: 14px; margin-top: 30px; margin-bottom: 30px; }
  #message { font-size: 20px; }
  #submitBtn { position: fixed; bottom: 15px; left: 10px; right: 10px; z-index: 1000; }
}
</style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Department Logo">
  <h1>PhD Seminar Evaluation</h1>

  <div class="navbar">
    <a href="https://kunakd.github.io/phd-seminar-voting/results.html" class="nav-btn">Results</a>
    <a href="https://kunakd.github.io/phd-seminar-voting/feedback.html" class="nav-btn">Feedback</a>
  </div>
</header>

<div class="instructions">
  <p><strong>Instructions for Email/Name</strong></p>
  <p>Students: Please enter your faculty email (...@natur.cuni.cz) or IOCB email (...@uochb.cas.cz).</p>
  <p>Academic staff: Please enter your full name (name and surname).</p>
</div>

<form id="voteForm">
  <label for="participantId">Email/Name</label>
  <input type="text" id="participantId" required>

  <label for="seminar">Select seminar</label>
  <select id="seminar" required>
    <option value="">--Select--</option>
  </select>

  <div id="presentations"></div>

  <button type="submit" id="submitBtn">Submit evaluation</button>
</form>

<div id="message" aria-live="polite"></div>

<script>
// ------------------- Utility & Config -------------------
const DRAFT_KEY = 'phd_eval_draft';
function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

function safeIdForDoc(str){
  if(!str) return '';
  return String(str).trim().replace(/[.#$/\\[\\]]/g, '_');
}

function showMessage(text, type){
  const el = document.getElementById('message');
  el.textContent = text || '';
  el.className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
}

// ------------------- Firebase init -------------------
const firebaseConfig = {
  apiKey: "AIzaSyA3oSDoF5LC6pweqVinV2ykpJopQwFWulM",
  authDomain: "phd-seminar-voting.firebaseapp.com",
  projectId: "phd-seminar-voting",
  storageBucket: "phd-seminar-voting.firebasestorage.app",
  messagingSenderId: "1042633812969",
  appId: "1:1042633812969:web:7fa70745a53338ec5ab978"
};

let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
} catch (e) {
  console.error('Firebase init error', e);
  showMessage('Warning: backend failed to initialize. Drafts will still be saved locally.', 'error');
}

// ------------------- Data -------------------
const seminars = [
  { name: "Seminar 1", date: "2025-11-14" },
  { name: "Seminar 2", date: "2025-12-12" },
  { name: "Seminar 3", date: "2026-01-16" },
  { name: "Seminar 4", date: "2026-02-13" },
  { name: "Seminar 5", date: "2026-04-10" },
  { name: "Seminar 6", date: "2026-05-15" }
];

const presentationsBySeminar = {
  "Seminar 1": ["Marko Boskovic", "Büşra Buse Tütüncü", "Samanta Rožánková", "Yu-Wei Tu"],
  "Seminar 2": ["Bart Kieftenbelt", "Ema Bažíková", "Pratibha Choudhari"],
  "Seminar 3": ["Anna-Marie Dušková", "Pallavi Halkarni", "Pipatpon Raksapon", "Ondřej Daněk"],
  "Seminar 4": ["Filip Trajhan", "Alicia León Rodríguez", "Jakub Krištof", "Andrea Vopálenská"],
  "Seminar 5": ["Ondřej Hladík", "Lucie Černá", "Shubham Bhatt", "Nidhi Sinha"],
  "Seminar 6": ["Najam Ul Sahar", "Jyotpreet Kaur", "Sandip Baban Shinde", "Dominik Kunák"]
};

// ------------------- DOM refs -------------------
const seminarSelect = document.getElementById("seminar");
const presDiv = document.getElementById("presentations");
const form = document.getElementById("voteForm");
const message = document.getElementById("message");
const submitBtn = document.getElementById("submitBtn");
const participantInput = document.getElementById("participantId");

function beforeUnloadListener(e){ e.preventDefault(); e.returnValue = ''; }
window.addEventListener('beforeunload', beforeUnloadListener);

// ------------------- Populate seminars -------------------
function updateSeminarDropdown(){
  seminarSelect.innerHTML = '<option value="">--Select--</option>';
  const now = new Date();
  seminars.forEach(s=>{
    const date = new Date(s.date);
    const openDate = new Date(date); openDate.setDate(openDate.getDate()-1);
    const opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = `${s.name} on ${date.toLocaleDateString('en-GB')}`;
    if(now < openDate){
      opt.disabled = true;
      opt.textContent += ' (not yet open)';
      opt.title = `Voting opens ${openDate.toLocaleDateString('en-GB')}`;
    }
    seminarSelect.appendChild(opt);
  });
}
updateSeminarDropdown();

// ------------------- Render presentations -------------------
function renderPresentations(seminar){
  presDiv.innerHTML = '';
  if(!seminar) return;
  const list = presentationsBySeminar[seminar] || [];
  list.forEach((name, i)=>{
    const block = document.createElement('div');
    block.className = 'presentation-block';
    block.innerHTML = `
      <h3>${name}</h3>
      <label>Score (1 = worst, 10 = best)</label>
      <select id="pres${i+1}" data-idx="${i}" required>
        <option value="">--Select--</option>
        ${Array.from({length:10},(_,x)=>`<option value="${x+1}">${x+1}</option>`).join('')}
      </select>
      <label>What should be improved?</label>
      <textarea id="comment${i+1}" data-idx="${i}" rows="3"></textarea>
      <div class="checkbox-row">
        <input type="checkbox" id="nocmt${i+1}" data-idx="${i}">
        <label for="nocmt${i+1}">No comments</label>
      </div>
    `;
    presDiv.appendChild(block);

    const checkbox = block.querySelector(`#nocmt${i+1}`);
    const textarea = block.querySelector(`#comment${i+1}`);
    checkbox.addEventListener('change', ()=>{
      textarea.disabled = checkbox.checked;
      if(checkbox.checked) textarea.value = '';
      saveDraftDebounced();
    });
  });

  loadDraftIntoDOM();
}

// ------------------- Draft save/load -------------------
function gatherDraft(){
  const draft = { participantId: participantInput.value || '', seminar: seminarSelect.value || '', presentations: [] };
  const seminar = seminarSelect.value;
  if(seminar && presentationsBySeminar[seminar]){
    presentationsBySeminar[seminar].forEach((_, i)=>{
      const score = document.getElementById(`pres${i+1}`)?.value || '';
      const comment = document.getElementById(`comment${i+1}`)?.value || '';
      const noComment = document.getElementById(`nocmt${i+1}`)?.checked || false;
      draft.presentations.push({ score, comment, noComment });
    });
  }
  draft.savedAt = new Date().toISOString();
  return draft;
}

function saveDraft(){ try{ const data = gatherDraft(); localStorage.setItem(DRAFT_KEY, JSON.stringify(data)); }catch(e){console.error(e);} }
const saveDraftDebounced = debounce(saveDraft, 300);

function loadDraftIntoDOM(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    if(data.participantId) participantInput.value = data.participantId;
    if(data.seminar && !seminarSelect.value) seminarSelect.value = data.seminar;
    if(data.presentations && data.presentations.length){
      data.presentations.forEach((p, i)=>{
        const scoreEl = document.getElementById(`pres${i+1}`);
        const cmtEl = document.getElementById(`comment${i+1}`);
        const chkEl = document.getElementById(`nocmt${i+1}`);
        if(scoreEl) scoreEl.value = p.score || '';
        if(chkEl) chkEl.checked = p.noComment || false;
        if(cmtEl){ cmtEl.value = p.comment || ''; cmtEl.disabled = chkEl?.checked || false; }
      });
    }
  }catch(e){console.error(e);}
}

// ------------------- Events -------------------
seminarSelect.addEventListener('change', ()=>{ renderPresentations(seminarSelect.value); saveDraftDebounced(); });
document.addEventListener('input', saveDraftDebounced);
participantInput.addEventListener('input', saveDraftDebounced);

(function restoreOnLoad(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(raw){
      const data = JSON.parse(raw);
      if(data.seminar){
        const opt = Array.from(seminarSelect.options).find(o=>o.value === data.seminar);
        if(opt) seminarSelect.value = data.seminar;
      }
    }
  }catch(e){}
  if(seminarSelect.value) renderPresentations(seminarSelect.value);
  loadDraftIntoDOM();
})();

// ------------------- Submit -------------------
let isSubmitting = false;
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  showMessage('', '');
  if(isSubmitting) return;
  isSubmitting = true;
  submitBtn.disabled = true;
  window.removeEventListener('beforeunload', beforeUnloadListener);

  try{
    const participantIdRaw = participantInput.value.trim();
    const seminar = seminarSelect.value;
    if(!participantIdRaw || !seminar){ showMessage('Please fill in all required fields.', 'error'); return; }

    const list = presentationsBySeminar[seminar];
    if(!list || !list.length){ showMessage('No presentations found for selected seminar.', 'error'); return; }

    const evaluations = [];
    for(let i=0;i<list.length;i++){
      const scoreEl = document.getElementById(`pres${i+1}`);
      const chkEl = document.getElementById(`nocmt${i+1}`);
      const cmtEl = document.getElementById(`comment${i+1}`);
      const score = scoreEl?.value;
      const noComment = chkEl?.checked || false;
      const comment = noComment ? '' : (cmtEl?.value.trim() || '');
      if(!score){ showMessage('Please fill in a score for each presentation.', 'error'); return; }
      evaluations.push({ name: list[i], score: parseInt(score,10), comment });
    }

    const safeId = safeIdForDoc(`${participantIdRaw}_${seminar}`);
    const docRef = db ? db.collection('votes').doc(safeId) : null;

    if(!docRef){ window.addEventListener('beforeunload', beforeUnloadListener); showMessage('Backend not available. Your evaluation is saved locally as a draft.', 'error'); saveDraft(); return; }

    let existing = null;
    try{ existing = await docRef.get(); }catch(err){ console.warn(err); }
    if(existing && existing.exists){ showMessage('You have already submitted an evaluation for this seminar.', 'error'); return; }

    try{
      await docRef.set({
        participantId: participantIdRaw,
        seminar,
        presentations: evaluations,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      showMessage('Evaluation submitted successfully. Thank you!', 'success');
      localStorage.removeItem(DRAFT_KEY);
      form.reset();
      presDiv.innerHTML = '';
    }catch(err){ console.error(err); saveDraft(); showMessage('An error occurred while submitting. Your evaluation was saved locally as a draft.', 'error'); }

  }catch(ex){ console.error(ex); showMessage('An unexpected error occurred. Please try again.', 'error'); }
  finally{ isSubmitting = false; submitBtn.disabled = false; }
});
</script>

<footer>
  <img src="logo.jpg" alt="Faculty Logo">
  <p>© 2025 Department of Organic Chemistry, Faculty of Science, Charles University</p>
  <p>Hlavova 2030/8, Prague 2, 128 00 | Seminar Contacts: jiri.misek@natur.cuni.cz; dominik.kunak@natur.cuni.cz</p>
  <p><a href="https://orgchem.natur.cuni.cz/" target="_blank" style="color: #000; text-decoration: none;">https://orgchem.natur.cuni.cz</a></p>
</footer>

</body>
</html>
